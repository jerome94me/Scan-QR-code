<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>æ‰‹æ©Ÿç‰ˆ QR Code æƒæå™¨</title>
    
    <!-- jsQR CDN (ç´” JavaScript QR è§£ç¢¼å™¨) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <style>
        /* å­—é«”èˆ‡å…¨åŸŸè‰²èª¿ */
        @font-face {
            font-family: "Microsoft JhengHei Local";
            src: local("Microsoft JhengHei"), local("å¾®è»Ÿæ­£é»‘é«”");
        }
        :root{
            --bg: #f5f8fb;
            --card: #ffffff;
            --accent: #2563eb;
            --ok: #16a34a;
            --warn: #f59e0b;
            --danger: #ef4444;
            --muted: #6b7280;
        }
        html,body{
            height:100%;
            margin:0;
            font-family: "Microsoft JhengHei Local", "Microsoft JhengHei", "PingFang TC", "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color:#111827;
        }
        .container{
            display:flex;
            flex-direction:column;
            height:100%;
            padding:16px;
            box-sizing:border-box;
            max-width:500px;
            margin:0 auto;
        }
        h1{
            margin:0 0 4px 0;
            font-size:24px;
            text-align: center;
        }
        .subtitle{
            color:var(--muted);
            margin:0 0 16px 0;
            font-size:14px;
            text-align: center;
        }

        .controls{
            display:flex;
            gap:12px;
            margin-bottom:16px;
        }
        .btn{
            flex:1;
            padding:12px 16px;
            border-radius:10px;
            border: none;
            cursor:pointer;
            font-size:16px;
            font-weight:600;
            transition:all .2s ease;
            box-shadow:0 4px 10px rgba(0,0,0,0.1);
        }
        .btn:disabled{
            opacity:0.55;
            cursor:not-allowed;
            box-shadow:none;
        }
        .btn-camera{
            background:linear-gradient(180deg,#8b5cf6,#7c3aed);
            color:white;
        }
        .btn-upload {
            background: linear-gradient(180deg, #2563eb, #1e4bb8);
            color: white;
        }
        .btn-flashlight{
            background:linear-gradient(180deg,#eab308,#ca8a04);
            color:white;
        }
        .btn-flashlight.on{
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.6);
        }

        /* æƒæå€å¡Š */
        .scan-area {
            flex-grow:1;
            position:relative;
            border-radius:12px;
            overflow:hidden;
            box-shadow:0 8px 30px rgba(15,23,42,0.1);
            background:#000;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
        }
        video#scanner-video {
            width: 100%;
            height: 100%;
            object-fit:cover;
        }
        canvas#preview{
            width:100%;
            height:100%;
            object-fit:contain;
        }

        .result-overlay {
            position:absolute;
            bottom:0;
            left:0;
            right:0;
            background:rgba(0,0,0,0.6);
            padding:16px;
            color:white;
            transition: transform 0.3s ease-in-out;
            transform: translateY(100%);
        }
        .result-overlay.active {
            transform: translateY(0);
        }
        .result-text {
            font-size:16px;
            white-space:pre-wrap;
        }
        .status-text {
            font-size:14px;
            font-weight:700;
        }
        .btn-open{
            margin-top:10px;
            background:linear-gradient(180deg,#10b981,#059669);
            color:white;
            padding:8px 16px;
            border-radius:8px;
            font-size:14px;
            align-self: flex-start;
        }
        .btn-open:disabled{
            opacity:0.55;
            cursor:not-allowed;
        }

        /* éŸ¿æ‡‰å¼ */
        @media (orientation: landscape) and (max-width: 900px) {
            .container {
                flex-direction: row;
                justify-content: center;
                align-items: center;
                padding: 16px;
            }
            .content {
                flex-grow: 1;
                max-width: 60%;
            }
            .controls {
                flex-direction: column;
                margin-left: 16px;
                flex-shrink: 0;
            }
            .subtitle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container" role="main">
        <h1>ğŸ“· æ‰‹æ©Ÿç‰ˆ QR Code æƒæå™¨</h1>
        <p class="subtitle">å°‡æ‚¨çš„ç›¸æ©Ÿå°æº– QR Codeï¼Œæˆ–å¾ç›¸ç°¿ä¸­ä¸Šå‚³åœ–ç‰‡ã€‚</p>
        
        <div class="controls">
            <button id="btnCamera" class="btn btn-camera">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ</button>
            <button id="btnUpload" class="btn btn-upload">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</button>
            <button id="btnFlash" class="btn btn-flashlight" disabled style="display: none;">ğŸ”¦ æ‰‹é›»ç­’</button>
        </div>
        
        <div class="scan-area">
            <video id="scanner-video" playsinline></video>
            <canvas id="preview" style="display: none;"></canvas>
            <div class="result-overlay" id="resultOverlay">
                <div id="statusText" class="status-text"></div>
                <div id="resultText" class="result-text"></div>
                <button id="btnOpen" class="btn btn-open" disabled>ğŸŒ åœ¨æ–°åˆ†é é–‹å•Ÿ</button>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display:none;" />
        </div>
    </div>

<script>
    // å…ƒä»¶
    const btnCamera = document.getElementById('btnCamera');
    const btnUpload = document.getElementById('btnUpload');
    const btnFlash = document.getElementById('btnFlash');
    const btnOpen = document.getElementById('btnOpen');
    const scannerVideo = document.getElementById('scanner-video');
    const preview = document.getElementById('preview');
    const fileInput = document.getElementById('fileInput');
    const resultOverlay = document.getElementById('resultOverlay');
    const statusText = document.getElementById('statusText');
    const resultText = document.getElementById('resultText');

    const ctx = preview.getContext && preview.getContext('2d');
    
    let videoStream = null;
    let lastResult = null;
    let animationFrameId = null;
    let isCameraActive = false;
    let isFlashlightOn = false;

    // Helper: æ›´æ–°ç‹€æ…‹å€å¡Š
    function setStatus(type, text, result = null){
        let color = '#fff';
        if(type === 'ok') color = '#bbf7d0';
        else if(type === 'err') color = '#fecaca';
        else if(type === 'warn') color = '#fff0c2';
        
        statusText.textContent = text;
        statusText.style.color = color;
        
        resultText.textContent = result || '';
        resultOverlay.classList.toggle('active', !!result);
        
        btnOpen.disabled = !isUrl(result);
    }

    // æª¢æŸ¥æ˜¯å¦ç‚º URL (æ¥å— http/https)
    function isUrl(text){
        if (!text) return false;
        try{
            const u = new URL(text);
            return (u.protocol === 'http:' || u.protocol === 'https:');
        }catch(e){
            return false;
        }
    }

    // æŠŠ image æˆ– ImageBitmap ç•«åˆ° canvas (æœƒæ ¹æ“šå¤§å°ç¸®æ”¾)
    function drawImageToCanvas(img){
        const maxW = 1000, maxH = 720;
        let w = img.width, h = img.height;
        const ratio = Math.min(maxW / w, maxH / h, 1);
        w = Math.round(w * ratio);
        h = Math.round(h * ratio);
        preview.width = w;
        preview.height = h;
        ctx.clearRect(0,0,preview.width, preview.height);
        ctx.drawImage(img, 0, 0, w, h);
    }
    
    // å¾ canvas å–å¾—å½±åƒè³‡æ–™ï¼Œäº¤çµ¦ jsQR è§£ç¢¼
    function decodeFromCanvas(){
        if(!ctx) return null;
        try {
            const imageData = ctx.getImageData(0, 0, preview.width, preview.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            return code;
        } catch(e) {
            console.error("Error getting image data:", e);
            return null;
        }
    }

    // è™•ç†åœ–ç‰‡çš„é€šç”¨å‡½å¼
    async function handleImage(img){
        stopCamera();
        scannerVideo.style.display = 'none';
        preview.style.display = 'block';

        if(img instanceof Blob){
            img = await createImageBitmap(img);
        }
        drawImageToCanvas(img);
        const code = decodeFromCanvas();
        if(code){
            lastResult = code.data;
            setStatus('ok', 'æƒææˆåŠŸ âœ…', 'æƒæçµæœï¼š\n\n' + lastResult);
        } else {
            lastResult = null;
            setStatus('err', 'æœªæ‰¾åˆ° QR Code âŒ', 'æœªåµæ¸¬åˆ°å¯è§£æçš„ QR Codeã€‚');
        }
    }

    // è™•ç†æ”å½±æ©Ÿä¸²æµ
    async function startCamera() {
        try {
            const constraints = { video: { facingMode: 'environment' } }; // å„ªå…ˆä½¿ç”¨å¾Œç½®é¡é ­
            videoStream = await navigator.mediaDevices.getUserMedia(constraints);
            scannerVideo.srcObject = videoStream;
            scannerVideo.setAttribute('playsinline', true);
            await scannerVideo.play();
            
            scannerVideo.style.display = 'block';
            preview.style.display = 'none';
            
            const track = videoStream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();
            if (capabilities.torch) {
                btnFlash.style.display = 'block';
                btnFlash.disabled = false;
            }

            setStatus('ok', 'æ”å½±æ©Ÿå·²é–‹å•Ÿï¼Œå³æ™‚æƒæä¸­...');
            
            isCameraActive = true;
            tick();

        } catch (err) {
            console.error(err);
            setStatus('err', 'ç„¡æ³•å­˜å–æ”å½±æ©Ÿ âŒ', 'è«‹ç¢ºèªå·²æˆäºˆç¶²ç«™ä½¿ç”¨æ”å½±æ©Ÿçš„æ¬Šé™ã€‚');
            btnFlash.disabled = true;
            btnFlash.style.display = 'none';
        }
    }
    
    // é–‹å•Ÿæˆ–é—œé–‰æ‰‹é›»ç­’
    async function toggleFlashlight() {
        if (!videoStream) return;
        const track = videoStream.getVideoTracks()[0];
        try {
            if (isFlashlightOn) {
                await track.applyConstraints({ advanced: [{ torch: false }] });
                isFlashlightOn = false;
                btnFlash.classList.remove('on');
            } else {
                await track.applyConstraints({ advanced: [{ torch: true }] });
                isFlashlightOn = true;
                btnFlash.classList.add('on');
            }
        } catch (err) {
            console.error("ç„¡æ³•æ§åˆ¶æ‰‹é›»ç­’:", err);
            btnFlash.disabled = true;
            btnFlash.style.display = 'none';
        }
    }

    function stopCamera() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
            scannerVideo.srcObject = null;
        }
        isCameraActive = false;
        isFlashlightOn = false;
        btnFlash.disabled = true;
        btnFlash.classList.remove('on');
        btnFlash.style.display = 'none';
    }

    function tick() {
        if (scannerVideo.readyState === scannerVideo.HAVE_ENOUGH_DATA) {
            preview.height = scannerVideo.videoHeight;
            preview.width = scannerVideo.videoWidth;
            ctx.drawImage(scannerVideo, 0, 0, preview.width, preview.height);
            const code = decodeFromCanvas();

            if (code) {
                lastResult = code.data;
                setStatus('ok', 'æƒææˆåŠŸ âœ…', 'æƒæçµæœï¼š\n\n' + lastResult);
                stopCamera();
                return;
            }
        }
        animationFrameId = requestAnimationFrame(tick);
    }
    
    // æŒ‰éˆ•äº‹ä»¶
    btnCamera.addEventListener('click', () => {
        if (isCameraActive) {
            stopCamera();
            btnCamera.textContent = 'ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ';
            setStatus('warn', 'ç›¸æ©Ÿå·²é—œé–‰', '');
        } else {
            startCamera();
            btnCamera.textContent = 'â¹ é—œé–‰ç›¸æ©Ÿ';
        }
    });
    
    btnUpload.addEventListener('click', () => {
        fileInput.click();
        setStatus('warn', 'ç­‰å¾…ä¸Šå‚³åœ–ç‰‡...');
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleImage(file);
        }
    });

    btnFlash.addEventListener('click', toggleFlashlight);

    btnOpen.addEventListener('click', () => {
        if(lastResult && isUrl(lastResult)){
            window.open(lastResult, '_blank', 'noopener');
        }
    });
    
    // åˆå§‹ç‹€æ…‹
    stopCamera();
    btnCamera.textContent = 'ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ';
    setStatus('warn', 'è«‹é»æ“ŠæŒ‰éˆ•ä¾†é–‹å§‹æƒæã€‚', '');

</script>
</body>
</html>
