<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>手機版 QR Code 掃描器</title>
    
    <!-- jsQR CDN (純 JavaScript QR 解碼器) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <style>
        /* 字體與全域色調 */
        @font-face {
            font-family: "Microsoft JhengHei Local";
            src: local("Microsoft JhengHei"), local("微軟正黑體");
        }
        :root{
            --bg: #f5f8fb;
            --card: #ffffff;
            --accent: #2563eb;
            --ok: #16a34a;
            --warn: #f59e0b;
            --danger: #ef4444;
            --muted: #6b7280;
        }
        html,body{
            height:100%;
            margin:0;
            font-family: "Microsoft JhengHei Local", "Microsoft JhengHei", "PingFang TC", "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color:#111827;
        }
        .container{
            display:flex;
            flex-direction:column;
            height:100%;
            padding:16px;
            box-sizing:border-box;
            max-width:500px;
            margin:0 auto;
        }
        h1{
            margin:0 0 4px 0;
            font-size:24px;
            text-align: center;
        }
        .subtitle{
            color:var(--muted);
            margin:0 0 16px 0;
            font-size:14px;
            text-align: center;
        }

        .controls{
            display:flex;
            gap:12px;
            margin-bottom:16px;
        }
        .btn{
            flex:1;
            padding:12px 16px;
            border-radius:10px;
            border: none;
            cursor:pointer;
            font-size:16px;
            font-weight:600;
            transition:all .2s ease;
            box-shadow:0 4px 10px rgba(0,0,0,0.1);
        }
        .btn:disabled{
            opacity:0.55;
            cursor:not-allowed;
            box-shadow:none;
        }
        .btn-camera{
            background:linear-gradient(180deg,#8b5cf6,#7c3aed);
            color:white;
        }
        .btn-upload {
            background: linear-gradient(180deg, #2563eb, #1e4bb8);
            color: white;
        }
        .btn-flashlight{
            background:linear-gradient(180deg,#eab308,#ca8a04);
            color:white;
        }
        .btn-flashlight.on{
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.6);
        }

        /* 掃描區塊 */
        .scan-area {
            flex-grow:1;
            position:relative;
            border-radius:12px;
            overflow:hidden;
            box-shadow:0 8px 30px rgba(15,23,42,0.1);
            background:#000;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
        }
        video#scanner-video {
            width: 100%;
            height: 100%;
            object-fit:cover;
        }
        canvas#preview{
            width:100%;
            height:100%;
            object-fit:contain;
        }

        .result-overlay {
            position:absolute;
            bottom:0;
            left:0;
            right:0;
            background:rgba(0,0,0,0.6);
            padding:16px;
            color:white;
            transition: transform 0.3s ease-in-out;
            transform: translateY(100%);
        }
        .result-overlay.active {
            transform: translateY(0);
        }
        .result-text {
            font-size:16px;
            white-space:pre-wrap;
        }
        .status-text {
            font-size:14px;
            font-weight:700;
        }
        .btn-open{
            margin-top:10px;
            background:linear-gradient(180deg,#10b981,#059669);
            color:white;
            padding:8px 16px;
            border-radius:8px;
            font-size:14px;
            align-self: flex-start;
        }
        .btn-open:disabled{
            opacity:0.55;
            cursor:not-allowed;
        }

        /* 響應式 */
        @media (orientation: landscape) and (max-width: 900px) {
            .container {
                flex-direction: row;
                justify-content: center;
                align-items: center;
                padding: 16px;
            }
            .content {
                flex-grow: 1;
                max-width: 60%;
            }
            .controls {
                flex-direction: column;
                margin-left: 16px;
                flex-shrink: 0;
            }
            .subtitle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container" role="main">
        <h1>📷 手機版 QR Code 掃描器</h1>
        <p class="subtitle">將您的相機對準 QR Code，或從相簿中上傳圖片。</p>
        
        <div class="controls">
            <button id="btnCamera" class="btn btn-camera">📸 開啟相機</button>
            <button id="btnUpload" class="btn btn-upload">📤 上傳圖片</button>
            <button id="btnFlash" class="btn btn-flashlight" disabled style="display: none;">🔦 手電筒</button>
        </div>
        
        <div class="scan-area">
            <video id="scanner-video" playsinline></video>
            <canvas id="preview" style="display: none;"></canvas>
            <div class="result-overlay" id="resultOverlay">
                <div id="statusText" class="status-text"></div>
                <div id="resultText" class="result-text"></div>
                <button id="btnOpen" class="btn btn-open" disabled>🌐 在新分頁開啟</button>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display:none;" />
        </div>
    </div>

<script>
    // 元件
    const btnCamera = document.getElementById('btnCamera');
    const btnUpload = document.getElementById('btnUpload');
    const btnFlash = document.getElementById('btnFlash');
    const btnOpen = document.getElementById('btnOpen');
    const scannerVideo = document.getElementById('scanner-video');
    const preview = document.getElementById('preview');
    const fileInput = document.getElementById('fileInput');
    const resultOverlay = document.getElementById('resultOverlay');
    const statusText = document.getElementById('statusText');
    const resultText = document.getElementById('resultText');

    const ctx = preview.getContext && preview.getContext('2d');
    
    let videoStream = null;
    let lastResult = null;
    let animationFrameId = null;
    let isCameraActive = false;
    let isFlashlightOn = false;

    // Helper: 更新狀態區塊
    function setStatus(type, text, result = null){
        let color = '#fff';
        if(type === 'ok') color = '#bbf7d0';
        else if(type === 'err') color = '#fecaca';
        else if(type === 'warn') color = '#fff0c2';
        
        statusText.textContent = text;
        statusText.style.color = color;
        
        resultText.textContent = result || '';
        resultOverlay.classList.toggle('active', !!result);
        
        btnOpen.disabled = !isUrl(result);
    }

    // 檢查是否為 URL (接受 http/https)
    function isUrl(text){
        if (!text) return false;
        try{
            const u = new URL(text);
            return (u.protocol === 'http:' || u.protocol === 'https:');
        }catch(e){
            return false;
        }
    }

    // 把 image 或 ImageBitmap 畫到 canvas (會根據大小縮放)
    function drawImageToCanvas(img){
        const maxW = 1000, maxH = 720;
        let w = img.width, h = img.height;
        const ratio = Math.min(maxW / w, maxH / h, 1);
        w = Math.round(w * ratio);
        h = Math.round(h * ratio);
        preview.width = w;
        preview.height = h;
        ctx.clearRect(0,0,preview.width, preview.height);
        ctx.drawImage(img, 0, 0, w, h);
    }
    
    // 從 canvas 取得影像資料，交給 jsQR 解碼
    function decodeFromCanvas(){
        if(!ctx) return null;
        try {
            const imageData = ctx.getImageData(0, 0, preview.width, preview.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            return code;
        } catch(e) {
            console.error("Error getting image data:", e);
            return null;
        }
    }

    // 處理圖片的通用函式
    async function handleImage(img){
        stopCamera();
        scannerVideo.style.display = 'none';
        preview.style.display = 'block';

        if(img instanceof Blob){
            img = await createImageBitmap(img);
        }
        drawImageToCanvas(img);
        const code = decodeFromCanvas();
        if(code){
            lastResult = code.data;
            setStatus('ok', '掃描成功 ✅', '掃描結果：\n\n' + lastResult);
        } else {
            lastResult = null;
            setStatus('err', '未找到 QR Code ❌', '未偵測到可解析的 QR Code。');
        }
    }

    // 處理攝影機串流
    async function startCamera() {
        try {
            const constraints = { video: { facingMode: 'environment' } }; // 優先使用後置鏡頭
            videoStream = await navigator.mediaDevices.getUserMedia(constraints);
            scannerVideo.srcObject = videoStream;
            scannerVideo.setAttribute('playsinline', true);
            await scannerVideo.play();
            
            scannerVideo.style.display = 'block';
            preview.style.display = 'none';
            
            const track = videoStream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();
            if (capabilities.torch) {
                btnFlash.style.display = 'block';
                btnFlash.disabled = false;
            }

            setStatus('ok', '攝影機已開啟，即時掃描中...');
            
            isCameraActive = true;
            tick();

        } catch (err) {
            console.error(err);
            setStatus('err', '無法存取攝影機 ❌', '請確認已授予網站使用攝影機的權限。');
            btnFlash.disabled = true;
            btnFlash.style.display = 'none';
        }
    }
    
    // 開啟或關閉手電筒
    async function toggleFlashlight() {
        if (!videoStream) return;
        const track = videoStream.getVideoTracks()[0];
        try {
            if (isFlashlightOn) {
                await track.applyConstraints({ advanced: [{ torch: false }] });
                isFlashlightOn = false;
                btnFlash.classList.remove('on');
            } else {
                await track.applyConstraints({ advanced: [{ torch: true }] });
                isFlashlightOn = true;
                btnFlash.classList.add('on');
            }
        } catch (err) {
            console.error("無法控制手電筒:", err);
            btnFlash.disabled = true;
            btnFlash.style.display = 'none';
        }
    }

    function stopCamera() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
            scannerVideo.srcObject = null;
        }
        isCameraActive = false;
        isFlashlightOn = false;
        btnFlash.disabled = true;
        btnFlash.classList.remove('on');
        btnFlash.style.display = 'none';
    }

    function tick() {
        if (scannerVideo.readyState === scannerVideo.HAVE_ENOUGH_DATA) {
            preview.height = scannerVideo.videoHeight;
            preview.width = scannerVideo.videoWidth;
            ctx.drawImage(scannerVideo, 0, 0, preview.width, preview.height);
            const code = decodeFromCanvas();

            if (code) {
                lastResult = code.data;
                setStatus('ok', '掃描成功 ✅', '掃描結果：\n\n' + lastResult);
                stopCamera();
                return;
            }
        }
        animationFrameId = requestAnimationFrame(tick);
    }
    
    // 按鈕事件
    btnCamera.addEventListener('click', () => {
        if (isCameraActive) {
            stopCamera();
            btnCamera.textContent = '📸 開啟相機';
            setStatus('warn', '相機已關閉', '');
        } else {
            startCamera();
            btnCamera.textContent = '⏹ 關閉相機';
        }
    });
    
    btnUpload.addEventListener('click', () => {
        fileInput.click();
        setStatus('warn', '等待上傳圖片...');
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleImage(file);
        }
    });

    btnFlash.addEventListener('click', toggleFlashlight);

    btnOpen.addEventListener('click', () => {
        if(lastResult && isUrl(lastResult)){
            window.open(lastResult, '_blank', 'noopener');
        }
    });
    
    // 初始狀態
    stopCamera();
    btnCamera.textContent = '📸 開啟相機';
    setStatus('warn', '請點擊按鈕來開始掃描。', '');

</script>
</body>
</html>
